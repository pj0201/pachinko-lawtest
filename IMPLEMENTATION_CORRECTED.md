# 🔧 実装修正レポート - テキストベース層化サンプリング

**修正日**: 2025-10-22
**修正項目**: 景品規制の不適切な除外 → テキスト内容に基づく正しい配分
**ステータス**: ✅ 修正完了・テスト推奨

---

## 🚨 主要な修正内容

### 発見された誤り

従来の実装では**景品規制を完全に除外（0%）**していました。
```python
# ❌ 誤った実装
category_distribution = {
    '遊技機管理': 0.50,
    '不正対策': 0.15,
    '営業許可関連': 0.12,
    '営業時間・規制': 0.12,
    '型式検定関連': 0.11,
    # '景品規制': 0.00  ← 除外（誤り！）
}
```

### 除外が誤りだった理由

**講習テキスト（220ページ）に景品規制が確実に含まれている**：
- 「景品」: 1回出現
- 「第22条」（風営法第22条 - 景品規制）: 14回出現
- 「賞品」（景品関連）: 23回出現
- **合計: 38回の出現**

→ テキストに含まれているコンテンツを出題範囲から除外することは不適切

---

## ✅ 修正内容

### 修正方針

「問題作成パターン12」（基本知識、ひっかけ等）ではなく、
**講習テキストの実際の内容構成に基づいて出題範囲を定義**

### テキスト構成（220ページ）

```
第1章 遊技機取扱主任者制度（制度編）   : 30～35ページ  (15%)
第2章 遊技場営業に関する規制（法令編） : 70～80ページ  (35%)
     ├─ 景品規制（第22条関連）を含む
第3章 遊技機取扱主任者の実務（実務編） : 100～110ページ (50%)
資料編・その他                        : 10～20ページ  (10%)
━━━━━━━━━━━━━━━━━━━━━━
合計: 220ページ
```

### 修正後の配分（テキストベース）

```python
✅ 修正後の実装（app.py の get_stratified_problems()）

category_distribution = {
    '遊技機管理': 0.40,          # 40% - 実務編（第3章）のメイン
    '営業時間・規制': 0.15,      # 15% - 法令編（第2章）
    '営業許可関連': 0.13,        # 13% - 法令編（第2章）
    '型式検定関連': 0.12,        # 12% - 法令編（第2章）
    '不正対策': 0.10,            # 10% - 実務編（第3章）
    '景品規制': 0.10,            # 10% - 法令編（第2章）★ テキストに含まれる
}
合計: 40% + 15% + 13% + 12% + 10% + 10% = 100% ✅
```

### 具体的な変更箇所

**ファイル**: `/home/planj/patshinko-exam-app/backend/app.py`
**メソッド**: `ProblemManager.get_stratified_problems()` (93～123行)

#### 変更1: ドキュメント更新
```
従来: 「遊技機取扱主任者の役割に基づいた最適な分布」
修正: 「講習テキスト内容に基づいた最適な分布」
      → 出題範囲を「職務」ではなく「テキスト」から決定
```

#### 変更2: 配分値の修正
```
# 旧
'遊技機管理': 0.50  →  新: 0.40 (10ポイント削減)
'不正対策': 0.15    →  新: 0.10 (5ポイント削減)
'営業許可関連': 0.12 → 新: 0.13 (1ポイント増加)
'営業時間・規制': 0.12 → 新: 0.15 (3ポイント増加)
'型式検定関連': 0.11 → 新: 0.12 (1ポイント増加)
'景品規制': (除外)   → 新: 0.10 (10ポイント新規追加) ★
```

---

## 📊 修正による影響

### 30問クイズでの出題数比較

| カテゴリ | 旧実装 | 新実装 | 変化 | 理由 |
|---------|------|------|------|------|
| **遊技機管理** | 15問 | 12問 | -3問 | 職務重視から適度に調整 |
| **営業時間・規制** | 4問 | 5問 | +1問 | 法令理解を強化 |
| **営業許可関連** | 4問 | 4問 | - | 同値 |
| **型式検定関連** | 3問 | 4問 | +1問 | 機械認証を強化 |
| **不正対策** | 4問 | 3問 | -1問 | 実務編内の調整 |
| **景品規制** | 0問 | 3問 | +3問 | ★ **テキスト内容に基づいて新規追加** |
| **合計** | **30問** | **30問** | - | - |

### 150問テストでの推定分布

```
修正後の期待値（層化サンプリング）:

遊技機管理:      150 × 0.40 = 60問  (40%)
営業時間・規制:  150 × 0.15 = 22～23問 (15%)
営業許可関連:    150 × 0.13 = 19～20問 (13%)
型式検定関連:    150 × 0.12 = 18問  (12%)
不正対策:        150 × 0.10 = 15問  (10%)
景品規制:        150 × 0.10 = 15問  (10%)
━━━━━━━━━━━━━━━━━━━━━
合計:            150問  (100%)
```

---

## 🔍 品質保証

### テキスト検証済み

✅ 講習テキスト（220ページ）全体スキャン完了
✅ 景品関連キーワード38回の出現確認
✅ 第2章（法令編）での景品規制の重要性確認
✅ テキスト構成による出題範囲の根拠確立

### 実装検証

✅ コード修正完了（app.py の get_stratified_problems）
✅ 配分値の合計が100%であることを確認
✅ すべてのカテゴリが正の値を持つことを確認
✅ 後方互換性の維持（エンドポイント仕様変更なし）

---

## 🧪 推奨テスト項目

### テスト1: 分布精度テスト（30問 × 5回）
```
期待値:
- 遊技機管理: 12問 (40%)
- 営業時間・規制: 4～5問 (15%)
- 営業許可関連: 4問 (13%)
- 型式検定関連: 3～4問 (12%)
- 不正対策: 3問 (10%)
- 景品規制: 3問 (10%) ← 新規追加、確認重要
```

### テスト2: 景品規制問題の品質確認
```
出現した景品規制問題について：
✓ 講習テキストの内容に基づいているか
✓ 法律参照が適切か
✓ 問題文の正確性
```

### テスト3: 統計的安定性テスト
```
150問テストで ±2% の精度確認
景品規制が 10% ± 2% の範囲に収まるか
```

---

## 📋 修正概要表

| 項目 | 状態 | 詳細 |
|------|------|------|
| **テキスト分析** | ✅ 完了 | TEXTBOOK_CONTENT_ANALYSIS.md 参照 |
| **誤りの発見** | ✅ 完了 | 景品規制の不適切な除外を確認 |
| **配分値の修正** | ✅ 完了 | テキスト基準に基づく新しい配分値 |
| **コード修正** | ✅ 完了 | app.py の get_stratified_problems() |
| **テスト実施** | ⏳ 推奨 | 修正後のテストを実施してください |
| **本番デプロイ** | ⏳ テスト後 | テスト合格後の本番反映 |

---

## 💡 重要なポイント

### 1. 「問題作成パターン」と「出題範囲」は別物
- **問題作成パターン（12種類）**: 問題の構造（基本知識、ひっかけ等）
- **出題範囲（6カテゴリ）**: テキストの内容（何を出題するか）

### 2. テキスト内容を無視した除外はできない
講習テキストに含まれている内容を出題範囲から除外することは、
試験の公平性や信頼性を損なう。

### 3. 職務分析と教材分析は別の視点
- 職務分析: 「取扱主任者として何が必要か」
- 教材分析: 「テキストで何を学ぶべきか」

両者のバランスを取ることが重要。今回はテキスト内容を優先。

---

## 📝 ドキュメント参照

- **詳細分析**: `TEXTBOOK_CONTENT_ANALYSIS.md` (このリポジトリ内)
- **実装コード**: `/home/planj/patshinko-exam-app/backend/app.py` (93～123行)
- **テスト結果**: （テスト実施後に作成予定）

---

## 🎯 次のステップ

1. **テスト実施**: 修正後の層化サンプリングが正しく動作することを確認
2. **Worker2 レビュー**: 修正内容を適切にレビュー
3. **本番デプロイ**: テスト合格後に本番環境へ反映

---

**修正者**: Claude Code
**修正日時**: 2025-10-22
**修正理由**: 講習テキスト内容に基づく正しい出題範囲の確立

---

**⚠️ 重要**: この修正により、景品規制は今後の出題に含まれます。
これはテキスト内容に基づいた正しい決定です。
