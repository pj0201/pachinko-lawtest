# 将来的な機能拡張 - アカウント管理機能

## 概要

現在のVercel KV実装では、メールアドレスをアカウントの唯一キーとして使用していますが、以下の機能は未実装です。将来的な拡張として検討する価値があります。

---

## 未実装機能リスト

### 1. アカウント復旧機能

**現状:**
- デバイスを紛失/初期化した場合、アカウントへのアクセス不可能
- localStorage クリアでデータ消失

**提案実装:**
```
1. ユーザーがメールアドレスを入力
2. Vercel KV でメールアドレス存在確認
3. 復旧コードを生成（6桁の数字）
4. メール送信（Resend API / SendGrid）
5. ユーザーがコード入力
6. 新しいセッショントークン発行
7. 新デバイスIDにバインド
```

**必要なコンポーネント:**
- `/api/request-recovery` - 復旧リクエストAPI
- `/api/verify-recovery-code` - 復旧コード検証API
- メール送信サービス（Resend推奨 - Vercel統合済み）
- フロントエンド: アカウント復旧画面

**優先度:** 高（ユーザー体験に直結）

**工数見積もり:** 2-3日

---

### 2. パスワードリセット機能

**現状:**
- パスワード自体が存在しない（招待URL + デバイスバインディングのみ）

**提案実装（オプションA: パスワード認証追加）:**
```
1. 登録時にパスワード設定を追加
2. ログイン画面でメール + パスワード認証
3. パスワード忘れ → メールで復旧リンク送信
4. bcrypt でパスワードハッシュ化
```

**提案実装（オプションB: パスワードレス継続）:**
```
現在の招待URL方式を維持し、パスワードなし
→ 復旧はメール認証コードのみ
```

**推奨:** オプションB（シンプル、セキュア）

**優先度:** 中（現状パスワードなしで運用可能）

**工数見積もり:**
- オプションA: 3-4日
- オプションB: アカウント復旧機能に含まれる

---

### 3. 既存アカウントへのログイン機能

**現状:**
- 新規登録のみ対応
- 既存ユーザーは同じデバイスでのみアクセス可能（localStorageベース）

**提案実装:**
```
1. ログイン画面追加
2. メールアドレス入力
3. メールで認証コード送信（6桁）
4. コード検証
5. セッショントークン発行
6. デバイスIDを新デバイスに更新 または 複数デバイス許可
```

**課題:**
- 現在の設計: 1アカウント = 1デバイス
- ログイン実装なら: 1アカウント = 複数デバイス？
- **設計方針の決定が必要**

**選択肢:**
- A. デバイス切り替え（古いデバイスは無効化）
- B. 複数デバイス許可（デバイスIDリストで管理）

**優先度:** 高（ユーザー利便性）

**工数見積もり:** 2-3日

---

### 4. メール送信機能

**現状:**
- メール送信機能なし
- メールアドレスはKVに保存されるのみ

**提案実装（Resend API）:**

Vercel推奨のメール送信サービス - 無料プランあり

```javascript
// api/send-email.js
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

export default async function handler(req, res) {
  const { email, code } = req.body;

  await resend.emails.send({
    from: 'noreply@yourdomain.com',
    to: email,
    subject: 'アカウント復旧コード',
    html: `
      <h1>アカウント復旧コード</h1>
      <p>以下のコードを入力してください:</p>
      <h2>${code}</h2>
      <p>このコードは10分間有効です。</p>
    `
  });

  res.json({ success: true });
}
```

**必要な設定:**
1. Resend アカウント作成（無料）
2. ドメイン認証（または Resend のテストドメイン使用）
3. API キーを Vercel 環境変数に設定

**Resend 無料プラン:**
- 3,000通/月
- 1通/秒
- テスト用途に十分

**代替サービス:**
- SendGrid（複雑、高機能）
- Postmark（シンプル、高速）

**優先度:** 高（アカウント復旧に必須）

**工数見積もり:** 1日（Resend統合はシンプル）

---

## 実装優先順位

### フェーズ1: 基本的なアカウント復旧（推奨）
1. ✅ メール送信機能（Resend統合）
2. ✅ アカウント復旧機能（メール認証コード）

**工数:** 3-4日
**ユーザー価値:** 高

### フェーズ2: 既存アカウントへのログイン
3. ✅ ログイン機能（メール認証コード）
4. ✅ デバイス切り替え or 複数デバイス対応

**工数:** 2-3日
**ユーザー価値:** 高

### フェーズ3: パスワード認証（オプション）
5. ⚠️ パスワード設定・認証機能

**工数:** 3-4日
**ユーザー価値:** 中（パスワードレスで運用可能）

---

## 技術スタック（推奨）

### メール送信
- **Resend** - Vercel公式推奨、シンプル、無料プランあり
- 環境変数: `RESEND_API_KEY`

### 認証コード生成
```javascript
// 6桁の数字
const code = Math.floor(100000 + Math.random() * 900000).toString();
```

### 認証コード保存（Vercel KV）
```javascript
// 10分間有効
await kv.set(`recovery:${email}`, code, { ex: 600 });
```

### パスワードハッシュ（必要な場合）
- **bcrypt** - 業界標準、セキュア

---

## セキュリティ考慮事項

### 認証コード
- ✅ 6桁の数字（100万通り）
- ✅ 10分間で期限切れ
- ✅ 3回失敗でロック（ブルートフォース対策）
- ✅ 使用後は即座に削除

### メール送信
- ✅ Rate limiting（1メール/分/アドレス）
- ✅ スパム対策（reCAPTCHA検討）

### デバイス管理
- ✅ デバイス数制限（最大5台など）
- ✅ デバイス名/最終アクセス日時を表示

---

## コスト見積もり

### Resend（メール送信）
- 無料プラン: 3,000通/月
- 想定使用量:
  - 100ユーザー × 月2回復旧 = 200通/月
  - **無料プランで十分**

### Vercel KV（追加データ）
- 認証コード一時保存（10分で削除）
- デバイスリスト保存（必要な場合）
- **現在の無料プラン内で収まる見込み**

**総コスト:** 無料（初期段階）

---

## 実装開始時のチェックリスト

### 開始前
- [ ] Resend アカウント作成
- [ ] ドメイン認証（または Resend テストドメイン使用）
- [ ] RESEND_API_KEY を Vercel 環境変数に設定
- [ ] デバイス管理方針の決定（切り替え or 複数許可）

### 実装中
- [ ] `/api/request-recovery` API
- [ ] `/api/verify-recovery-code` API
- [ ] `/api/send-email` ユーティリティ
- [ ] フロントエンド: アカウント復旧画面
- [ ] フロントエンド: ログイン画面
- [ ] Rate limiting 実装
- [ ] エラーハンドリング

### テスト
- [ ] メール送信テスト
- [ ] 認証コード検証テスト
- [ ] デバイス切り替えテスト
- [ ] セキュリティテスト（ブルートフォース対策）

---

## 参考リンク

- [Resend Documentation](https://resend.com/docs)
- [Vercel KV Documentation](https://vercel.com/docs/storage/vercel-kv)
- [bcrypt npm package](https://www.npmjs.com/package/bcrypt)

---

## 補足

この issue は将来的な拡張として作成されました。**すぐには実装しません**が、ロードマップとして保持します。

実装を開始する際は、この issue を参照してタスクを細分化してください。
