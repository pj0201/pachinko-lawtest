#!/usr/bin/env python3
"""
éŠæŠ€æ©Ÿå–æ‰±ä¸»ä»»è€…è©¦é¨“å•é¡Œç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  v2.0 FIXED
12ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ´»ç”¨ã—ãŸé‡è¤‡æ’é™¤ç‰ˆ
Version: 2.0 FIXED
Date: 2025-11-02
"""

import json
import random
from datetime import datetime
from typing import Dict, List, Optional
from collections import defaultdict

class ProblemsGeneratorV2Fixed:
    """12ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã®å•é¡Œç”Ÿæˆã‚¯ãƒ©ã‚¹"""

    def __init__(self):
        """åˆæœŸåŒ–"""
        self.categories = self._initialize_categories()
        self.patterns = self._initialize_patterns()
        self.problem_templates = self._initialize_problem_templates()
        self.problem_id_counter = 1
        self.problems = []
        self.generated_texts = set()  # é‡è¤‡æ’é™¤ç”¨

    def _initialize_categories(self) -> Dict:
        """ã‚«ãƒ†ã‚´ãƒªã‚’åˆæœŸåŒ–"""
        return {
            "å–¶æ¥­è¨±å¯": {"id": 1000, "articles": "ç¬¬3æ¡ã€œç¬¬8æ¡"},
            "å–¶æ¥­æ‰€åŸºæº–": {"id": 2000, "articles": "ç¬¬9æ¡ã€œç¬¬10æ¡"},
            "éŠæŠ€æ©Ÿã®è¨­ç½®": {"id": 3000, "articles": "ç¬¬11æ¡ã€œç¬¬15æ¡"},
            "éŠæŠ€æ©Ÿã®èªå®š": {"id": 4000, "articles": "ç¬¬16æ¡ã€œç¬¬20æ¡"},
            "æ™¯å“è¦åˆ¶": {"id": 5000, "articles": "ç¬¬21æ¡ã€œç¬¬25æ¡"},
            "å–¶æ¥­æ™‚é–“": {"id": 6000, "articles": "ç¬¬26æ¡ã€œç¬¬30æ¡"},
            "ä¸æ­£é˜²æ­¢": {"id": 7000, "articles": "ç¬¬31æ¡ã€œç¬¬35æ¡"},
            "ç›£ç£ãƒ»æŒ‡å°": {"id": 8000, "articles": "ç¬¬36æ¡ã€œç¬¬40æ¡"},
            "è³‡æ ¼è¦ä»¶": {"id": 9000, "articles": "ç¬¬41æ¡ã€œç¬¬45æ¡"},
            "æ³•æ”¹æ­£": {"id": 10000, "articles": "æœ€æ–°æ”¹æ­£äº‹é …"}
        }

    def _initialize_patterns(self) -> Dict:
        """12ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆæœŸåŒ–"""
        return {
            1: {"name": "åŸºæœ¬çŸ¥è­˜", "difficulty": "â˜…", "weight": 0.15},
            2: {"name": "ã²ã£ã‹ã‘", "difficulty": "â˜…â˜…", "weight": 0.30},
            3: {"name": "ç”¨èªæ¯”è¼ƒ", "difficulty": "â˜…â˜…", "weight": 0.10},
            4: {"name": "å„ªå…ˆé †ä½", "difficulty": "â˜…â˜…", "weight": 0.08},
            5: {"name": "æ™‚ç³»åˆ—ç†è§£", "difficulty": "â˜…â˜…â˜…", "weight": 0.10},
            6: {"name": "ã‚·ãƒŠãƒªã‚ªåˆ¤å®š", "difficulty": "â˜…â˜…â˜…", "weight": 0.10},
            7: {"name": "è¤‡åˆé•å", "difficulty": "â˜…â˜…â˜…", "weight": 0.05},
            8: {"name": "æ•°å€¤æ­£ç¢ºæ€§", "difficulty": "â˜…", "weight": 0.05},
            9: {"name": "ç†ç”±ç†è§£", "difficulty": "â˜…â˜…â˜…", "weight": 0.03},
            10: {"name": "çµŒé¨“é™¥é˜±", "difficulty": "â˜…â˜…â˜…", "weight": 0.02},
            11: {"name": "æ”¹æ­£å¯¾å¿œ", "difficulty": "â˜…â˜…â˜…", "weight": 0.01},
            12: {"name": "è¤‡åˆå¿œç”¨", "difficulty": "â˜…â˜…â˜…â˜…", "weight": 0.01}
        }

    def _initialize_problem_templates(self) -> Dict:
        """ãƒ‘ã‚¿ãƒ¼ãƒ³ã”ã¨ã«è±Šå¯Œãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å®šç¾©"""
        # æ±ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆå…¨ã‚«ãƒ†ã‚´ãƒªã§ä½¿ç”¨å¯èƒ½ï¼‰
        generic_templates = {
            "å–¶æ¥­è¨±å¯": ["å–¶æ¥­è¨±å¯", "å–¶æ¥­è€…", "è¨±å¯ç”³è«‹"],
            "å–¶æ¥­æ‰€åŸºæº–": ["å–¶æ¥­æ‰€", "æ–½è¨­è¦ä»¶", "è¨­å‚™åŸºæº–"],
            "éŠæŠ€æ©Ÿã®è¨­ç½®": ["éŠæŠ€æ©Ÿ", "è¨­ç½®", "æ–°å°"],
            "éŠæŠ€æ©Ÿã®èªå®š": ["å‹å¼æ¤œå®š", "èªå®š", "åˆæ ¼"],
            "æ™¯å“è¦åˆ¶": ["æ™¯å“", "æ”¯çµ¦é¡", "ç¨®é¡åˆ¶é™"],
            "å–¶æ¥­æ™‚é–“": ["å–¶æ¥­ç¦æ­¢æ™‚é–“", "å–¶æ¥­æ™‚é–“", "æ™‚é–“å¸¯"],
            "ä¸æ­£é˜²æ­¢": ["ä¸æ­£æ”¹é€ ", "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£", "é˜²æ­¢"],
            "ç›£ç£ãƒ»æŒ‡å°": ["ç›£ç£", "æŒ‡å°", "å ±å‘Š"],
            "è³‡æ ¼è¦ä»¶": ["ä¸»ä»»è€…", "è³‡æ ¼", "è¦ä»¶"],
            "æ³•æ”¹æ­£": ["æ”¹æ­£", "æ–°è¦å®š", "å¯¾å¿œ"]
        }

        return {
            1: {  # åŸºæœ¬çŸ¥è­˜ - 25å€‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                "å–¶æ¥­è¨±å¯": [
                    {"text": "å–¶æ¥­è¨±å¯ã¯éƒ½é“åºœçœŒå…¬å®‰å§”å“¡ä¼šã‹ã‚‰å—ã‘ã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "å–¶æ¥­è¨±å¯ã®æœ‰åŠ¹æœŸé™ã¯{period}å¹´ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"period": [3, 5]}},
                    {"text": "å–¶æ¥­è¨±å¯ã¯å–¶æ¥­æ‰€å†…ã«æ²ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "å–¶æ¥­è¨±å¯ã¯{name}ã«è©²å½“ã™ã‚‹è€…ã«ã¯ä»˜ä¸ã•ã‚Œãªã„ã€‚", "answer": "â—‹", "vars": {"name": ["æœªæˆå¹´è€…", "ç¦æ²»ç”£è€…"]}},
                    {"text": "{location}ã§ã®å–¶æ¥­è¨±å¯ç”³è«‹ã¯å¯èƒ½ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"location": ["æŒ‡å®šåœ°åŸŸå†…", "åŸºæº–ã‚’æº€ãŸã™åœ°åŸŸ"]}},
                    {"text": "å–¶æ¥­è¨±å¯ã¯ç›¸ç¶šã«ã‚ˆã‚Šæ‰¿ç¶™ã§ãã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "å–¶æ¥­è¨±å¯ç”³è«‹ã«å¿…è¦ãªæ›¸é¡ã«ã¯{doc}ãŒå«ã¾ã‚Œã‚‹ã€‚", "answer": "â—‹", "vars": {"doc": ["å–¶æ¥­è¨ˆç”»æ›¸", "é…ç½®å›³"]}},
                    {"text": "å–¶æ¥­è¨±å¯ã¯{purpose}ã«ã‚ˆã‚Šå–ã‚Šæ¶ˆã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"purpose": ["é•åãŒç¶šãå ´åˆ", "æ–½è¨­ä¸å…·åˆ"]}},
                    {"text": "å–¶æ¥­æ‰€ã®æ§‹é€ ãƒ»è¨­å‚™ã¯æ³•å®šåŸºæº–ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "è¨±å¯å–å¾—å¾Œã®{change}ã¯å±Šå‡ºãŒå¿…è¦ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"change": ["å–¶æ¥­è€…å¤‰æ›´", "æ–½è¨­å¤‰æ›´"]}},
                    {"text": "å–¶æ¥­è¨±å¯ç”³è«‹ã¯å–¶æ¥­é–‹å§‹ã®{period}æ—¥å‰ã‹ã‚‰å¯èƒ½ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"period": [30, 60]}},
                    {"text": "å–¶æ¥­è¨±å¯ã®æ›´æ–°æ‰‹ç¶šãã¯æœ‰åŠ¹æœŸé™å†…ã«ç”³è«‹ã™ã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "å–¶æ¥­è¨±å¯ç”³è«‹ã«ã¯{qualification}ãŒå¿…è¦ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"qualification": ["ä¸»ä»»è€…è³‡æ ¼", "æ–½è¨­è¦ä»¶"]}},
                    {"text": "å–¶æ¥­è¨±å¯ã¯{transferable}ã“ã¨ãŒã§ããªã„ã€‚", "answer": "â—‹", "vars": {"transferable": ["è­²æ¸¡", "è»¢è²¸"]}},
                    {"text": "å–¶æ¥­ç¦æ­¢åŒºåŸŸã§ã®å–¶æ¥­è¨±å¯ç”³è«‹ã¯å—ç†ã•ã‚Œãªã„ã€‚", "answer": "â—‹"},
                    {"text": "å–¶æ¥­è€…ãŒå¤‰æ›´ã•ã‚Œã‚‹å ´åˆã¯æ–°è¦è¨±å¯ç”³è«‹ãŒå¿…è¦ã§ã‚ã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "å–¶æ¥­è¨±å¯ç”³è«‹ã«ã¯å–¶æ¥­è€…ã®{doc}ãŒå¿…è¦ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"doc": ["ä½æ°‘ç¥¨", "èº«åˆ†è¨¼æ˜æ›¸"]}},
                    {"text": "å–¶æ¥­æ‰€ã®æœ€å°é¢ç©ã¯æ³•ä»¤ã§å®šã‚ã‚‰ã‚Œã¦ã„ã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "å–¶æ¥­è¨±å¯ã®æœ‰åŠ¹æœŸé–“ä¸­ã¯å®šæœŸå ±å‘ŠãŒå¿…è¦ã§ã‚ã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "å–¶æ¥­è¨±å¯ã¯åŒä¸€äººç‰©ãŒè¤‡æ•°ã®å–¶æ¥­æ‰€ã§{condition}ã€‚", "answer": "â—‹", "vars": {"condition": ["å–å¾—å¯èƒ½ã§ã‚ã‚‹", "ç”³è«‹å¯èƒ½ã§ã‚ã‚‹"]}}
                ],
                "éŠæŠ€æ©Ÿã®èªå®š": [
                    {"text": "éŠæŠ€æ©Ÿã®å‹å¼æ¤œå®šã¯{period}å¹´ã”ã¨ã«æ›´æ–°ãŒå¿…è¦ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"period": [3, 5]}},
                    {"text": "å‹å¼æ¤œå®šåˆæ ¼æ©Ÿã¯å‹å¼æ¤œå®šæ¨™ç¥¨ã‚’è¡¨ç¤ºã™ã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "ä¸­å¤éŠæŠ€æ©Ÿã®è¨­ç½®ã«ã¯å‹å¼æ¤œå®šåˆæ ¼ãŒå¿…é ˆã§ã‚ã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "å‹å¼æ¤œå®šã®ç”³è«‹ã¯{organization}ã«è¡Œã†ã€‚", "answer": "â—‹", "vars": {"organization": ["éƒ½é“åºœçœŒ", "æŒ‡å®šæ¤œæŸ»æ©Ÿé–¢"]}},
                    {"text": "å‹å¼æ¤œå®šæ›´æ–°ç”³è«‹ã¯æœ‰åŠ¹æœŸé™ã®{days}æ—¥å‰ã‹ã‚‰å¯èƒ½ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"days": [30, 90]}}
                ],
                "æ™¯å“è¦åˆ¶": [
                    {"text": "æ™¯å“ã®ç¨®é¡ã¨é‡‘é¡ã¯æ³•å¾‹ã§å®šã‚ã‚‰ã‚Œã¦ã„ã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "æ™¯å“ã®æœ€é«˜é¡ã¯{amount}å††ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"amount": [10000, 20000, 50000]}}
                ],
                "å–¶æ¥­æ™‚é–“": [
                    {"text": "å–¶æ¥­ç¦æ­¢æ™‚é–“å¸¯ã«ãŠã‘ã‚‹å–¶æ¥­ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "å–¶æ¥­æ™‚é–“ã®åˆ¶é™ã¯{purpose}ãŸã‚ã«è¨­ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã€‚", "answer": "â—‹", "vars": {"purpose": ["é’å°‘å¹´ä¿è­·", "ç¤¾ä¼šç§©åºç¶­æŒ"]}}
                ],
                "ä¸æ­£é˜²æ­¢": [
                    {"text": "éŠæŠ€æ©Ÿã®ä¸æ­£æ”¹é€ ã¯å³ã—ãç¦æ­¢ã•ã‚Œã¦ã„ã‚‹ã€‚", "answer": "â—‹"},
                    {"text": "éŠæŠ€æ©Ÿã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯{element}ã§ç¢ºä¿ã•ã‚Œã‚‹ã€‚", "answer": "â—‹", "vars": {"element": ["å‹å¼æ¤œå®š", "æ–½éŒ æ©Ÿæ§‹"]}}
                ]
            },
            2: {  # ã²ã£ã‹ã‘ - çµ¶å¯¾è¡¨ç¾ - 30å€‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                "å–¶æ¥­è¨±å¯": [
                    {"text": "å–¶æ¥­è¨±å¯ã¯{condition}å ´åˆã€å¿…ãšå–ã‚Šæ¶ˆã•ã‚Œã‚‹ã€‚", "answer": "Ã—", "explanation": "ã€Œå¿…ãšã€ã¯éåº¦ãªè¡¨ç¾ã€‚çŠ¶æ³åˆ¤æ–­ãŒå¿…è¦ã€‚"},
                    {"text": "å–¶æ¥­è¨±å¯ç”³è«‹ã¯èª°ã§ã‚‚{always}ã§ãã‚‹ã€‚", "answer": "Ã—", "explanation": "æ¬ æ ¼äº‹ç”±ã«è©²å½“ã™ã‚‹è€…ã¯ç”³è«‹ä¸å¯ã€‚", "vars": {"always": ["è‡ªç”±ã«", "ã„ã¤ã§ã‚‚"]}},
                    {"text": "å–¶æ¥­è¨±å¯ã®æœ‰åŠ¹æœŸé™ã¯{absolute}ç„¡æœŸé™ã§ã‚ã‚‹ã€‚", "answer": "Ã—", "explanation": "æœ‰åŠ¹æœŸé™ã¯æ³•å®šæœŸé–“ã«ã‚ˆã‚Šåˆ¶é™ã•ã‚Œã‚‹ã€‚", "vars": {"absolute": ["çµ¶å¯¾ã«", "å¸¸ã«"]}},
                    {"text": "å–¶æ¥­æ‰€ã®æ§‹é€ ã¯{strict}åŸºæº–ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚‹ã€‚", "answer": "Ã—", "explanation": "ã€Œå³å¯†ã«ã€ã§ã¯ãªãã€ŒåŸºæœ¬è¦ä»¶ã‚’ã€ãŒæ­£ç¢ºã€‚"},
                    {"text": "å–¶æ¥­è€…ã®å¤‰æ›´ã¯{always}å±Šå‡ºãŒå¿…é ˆã§ã‚ã‚‹ã€‚", "answer": "Ã—", "explanation": "çŠ¶æ³ã«å¿œã˜ã¦ç•°ãªã‚‹å ´åˆãŒã‚ã‚‹ã€‚", "vars": {"always": ["çµ¶å¯¾ã«", "å¿…ãš"]}},
                    {"text": "å–¶æ¥­è¨±å¯ã¯{impossible}è­²æ¸¡ã§ããªã„ã€‚", "answer": "Ã—", "explanation": "ã€Œçµ¶å¯¾ã«ã€ã§ã¯ãªãã€ŒåŸå‰‡ã¨ã—ã¦ã€ãŒæ­£ç¢ºã€‚", "vars": {"impossible": ["çµ¶å¯¾ã«", "æ±ºã—ã¦"]}},
                    {"text": "è¨±å¯ç”³è«‹æ›¸ã®è¨˜è¼‰äº‹é …ã¯{strict}å¤‰æ›´ä¸å¯ã§ã‚ã‚‹ã€‚", "answer": "Ã—", "explanation": "å¤‰æ›´ã®æ‰‹ç¶šããŒå­˜åœ¨ã™ã‚‹ã€‚"},
                    {"text": "å–¶æ¥­è¨±å¯ã¯{certain}ä¸å‹•ç”£ã®ã¿ã§æœ‰åŠ¹ã§ã‚ã‚‹ã€‚", "answer": "Ã—", "explanation": "ç‰¹å®šã®æ–½è¨­ã«é™å®šã•ã‚Œã‚‹ã€‚"},
                    {"text": "å‹å¼æ¤œå®šã®æœ‰åŠ¹æœŸé™ã¯{strict}çµ¶å¯¾{period}å¹´ã§ã‚ã‚‹ã€‚", "answer": "Ã—", "explanation": "å»¶é•·ç”³è«‹ãªã©ã®åˆ¶åº¦ãŒã‚ã‚‹ã€‚", "vars": {"strict": ["å³å¯†ã«", "çµ¶å¯¾"], "period": [3, 5]}},
                    {"text": "å–¶æ¥­åœæ­¢å‘½ä»¤ã¯{always}å¿…ãšå–¶æ¥­å»ƒæ­¢ã«è‡³ã‚‹ã€‚", "answer": "Ã—", "explanation": "å–¶æ¥­åœæ­¢ã§çµ‚ã‚ã‚‹å ´åˆã‚‚ã‚ã‚‹ã€‚"},
                    {"text": "å–¶æ¥­è¨±å¯ã¯{person}ã«å¯¾ã—ã¦å¿…ãšä»˜ä¸ã•ã‚Œã‚‹ã€‚", "answer": "Ã—", "explanation": "æ¬ æ ¼äº‹ç”±ã«ã‚ˆã‚Šä»˜ä¸ã•ã‚Œãªã„å ´åˆãŒã‚ã‚‹ã€‚", "vars": {"person": ["èª°ã«ã§ã‚‚", "ç”³è«‹è€…å…¨å“¡"]}},
                    {"text": "å–¶æ¥­æ‰€ã®ä½ç½®å¤‰æ›´ã¯{action}å ´åˆã€è‡ªå‹•çš„ã«å–ã‚Šæ¶ˆã•ã‚Œã‚‹ã€‚", "answer": "Ã—", "explanation": "å±Šå‡ºæ‰‹ç¶šããŒå¿…è¦ã€‚", "vars": {"action": ["å±Šå‡ºãªãå®Ÿæ–½ã—ãŸ", "ç„¡æ–­ã§å®Ÿæ–½ã—ãŸ"]}},
                    {"text": "å–¶æ¥­è¨±å¯ç”³è«‹ã«å¿…è¦ãªæ›¸é¡ã¯{always}çµ¶å¯¾ã«å¤‰ã‚ã‚‰ãªã„ã€‚", "answer": "Ã—", "explanation": "æ³•æ”¹æ­£ã«ã‚ˆã‚Šå¤‰æ›´ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ã€‚"},
                    {"text": "å‹å¼æ¤œå®šæ›´æ–°ã¯{impossible}ä¸€åº¦ã‚‚å»¶æœŸã§ããªã„ã€‚", "answer": "Ã—", "explanation": "æ­£å½“ãªç†ç”±ãŒã‚ã‚Œã°å»¶æœŸãŒèªã‚ã‚‰ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ã€‚"},
                    {"text": "æ™¯å“è¦åˆ¶é•åã¯{strict}ã©ã®ã‚ˆã†ãªå ´åˆã§ã‚‚åŒä¸€ç½°å‰‡ã§ã‚ã‚‹ã€‚", "answer": "Ã—", "explanation": "é•åã®ç¨‹åº¦ã«ã‚ˆã‚Šç½°å‰‡ã¯ç•°ãªã‚‹ã€‚"}
                ],
                "éŠæŠ€æ©Ÿã®èªå®š": [
                    {"text": "å‹å¼æ¤œå®šåˆæ ¼æ©Ÿã¯{always}å¿…ãšå–¶åˆ©ã«ä½¿ç”¨ã§ãã‚‹ã€‚", "answer": "Ã—"},
                    {"text": "ä¸­å¤æ©Ÿã®æ¤œå®šã¯{strict}æ–°å°ã¨åŒä¸€åŸºæº–ã§ã‚ã‚‹ã€‚", "answer": "Ã—"},
                    {"text": "å‹å¼æ¤œå®šã¯{certain}ä¸€åº¦åˆæ ¼ã™ã‚Œã°æ°¸é ã«æœ‰åŠ¹ã§ã‚ã‚‹ã€‚", "answer": "Ã—"},
                    {"text": "å‹å¼æ¤œå®šç”³è«‹ã¯{always}ã©ã‚“ãªéŠæŠ€æ©Ÿã§ã‚‚å¯èƒ½ã§ã‚ã‚‹ã€‚", "answer": "Ã—"},
                    {"text": "å‹å¼æ¤œå®šæ¨™ç¥¨ã¯{impossible}çµ¶å¯¾ã«å¤‰æ›´ã§ããªã„ã€‚", "answer": "Ã—"}
                ],
                "æ™¯å“è¦åˆ¶": [
                    {"text": "æ™¯å“ã¯{always}å…¨ã¦ã®ç¨®é¡ãŒæ”¯çµ¦å¯èƒ½ã§ã‚ã‚‹ã€‚", "answer": "Ã—"},
                    {"text": "æ™¯å“é¡ã¯{strict}å³æ ¼ã«åˆ¶é™ã•ã‚Œãªã„ã€‚", "answer": "Ã—"},
                    {"text": "æ™¯å“æ”¯çµ¦ã¯{certain}ä½•åº¦ã§ã‚‚{amount}å††ã¾ã§æ”¯çµ¦å¯èƒ½ã§ã‚ã‚‹ã€‚", "answer": "Ã—", "vars": {"amount": [10000, 20000]}}
                ]
            },
            3: {  # ç”¨èªæ¯”è¼ƒ - 20å€‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                "å–¶æ¥­è¨±å¯": [
                    {"text": "å–¶æ¥­è¨±å¯ã¨{other}ã¯ç•°ãªã‚‹æœ‰åŠ¹æœŸé™ã‚’æŒã¤ã€‚", "answer": "â—‹", "vars": {"other": ["å‹å¼æ¤œå®š", "èªå®šæ©Ÿé–¢ã®æŒ‡å®š"]}},
                    {"text": "{term1}ã¯{term2}ã¨ç•°ãªã‚Šã€æ›´æ–°ç”³è«‹ãŒå¿…è¦ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"term1": ["å‹å¼æ¤œå®š"], "term2": ["å–¶æ¥­è¨±å¯"]}},
                    {"text": "å–¶æ¥­è¨±å¯ã¨æ™¯å“è¦åˆ¶ã¯ç•°ãªã‚‹{element}ã§ç®¡ç†ã•ã‚Œã‚‹ã€‚", "answer": "â—‹", "vars": {"element": ["æ³•ä»¤", "æœŸé™", "æ¡æ–‡"]}},
                    {"text": "{location1}ã§ã®å–¶æ¥­è¨±å¯ã¯{location2}ã§ã®è¨±å¯ã¨ç•°ãªã‚‹ã€‚", "answer": "â—‹", "vars": {"location1": ["ç”²çœŒ"], "location2": ["ä¹™çœŒ"]}},
                    {"text": "å–¶æ¥­è¨±å¯ç”³è«‹ã¨æ›´æ–°ç”³è«‹ã¯{difference}ãŒç•°ãªã‚‹ã€‚", "answer": "â—‹", "vars": {"difference": ["å¿…è¦æ›¸é¡", "æ‰‹æ•°æ–™", "æœ‰åŠ¹æœŸé–“"]}},
                    {"text": "å–¶æ¥­åœæ­¢å‘½ä»¤ã¨å–¶æ¥­å»ƒæ­¢ã¯{different}ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"different": ["ç›®çš„ãŒç•°ãªã‚‹", "æœŸé–“ãŒç•°ãªã‚‹"]}}
                ],
                "æ™¯å“è¦åˆ¶": [
                    {"text": "æ™¯å“ã®æœ€é«˜é¡ã¨{other}ã¯ç•°ãªã‚‹åŸºæº–ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"other": ["å–¶æ¥­æ‰€ã®ä½ç½®", "å–¶æ¥­æ™‚é–“"]}},
                    {"text": "é‡‘éŠ­æ™¯å“ã¨{{other}}ã®æ”¯çµ¦é¡ä¸Šé™ã¯ç•°ãªã‚‹ã€‚", "answer": "â—‹", "vars": {"other": ["ç‰©å“æ™¯å“", "æœ‰ä¾¡è¨¼åˆ¸"]}}
                ],
                "å–¶æ¥­æ™‚é–“": [
                    {"text": "å–¶æ¥­ç¦æ­¢æ™‚é–“ã¨{related}ã¯ç•°ãªã‚‹ç›®çš„ã§è¦å®šã•ã‚Œã‚‹ã€‚", "answer": "â—‹", "vars": {"related": ["å–¶æ¥­åœæ­¢", "å–¶æ¥­æ™‚é–“åˆ¶é™"]}}
                ]
            },
            4: {  # å„ªå…ˆé †ä½ - 15å€‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                "å–¶æ¥­è¨±å¯": [
                    {"text": "{requirement1}ã¨{requirement2}ã‚’åŒæ™‚ã«æº€ãŸã™å¿…è¦ãŒã‚ã‚‹å ´åˆã€{requirement1}ã‚’å„ªå…ˆã™ã‚‹ã€‚", "answer": "Ã—", "vars": {"requirement1": ["å–¶æ¥­è¨±å¯"], "requirement2": ["å‹å¼æ¤œå®š"]}},
                    {"text": "å–¶æ¥­è¨±å¯ã¨å‹å¼æ¤œå®šã®ç”³è«‹é †åºã¯{order}ãŒæ­£ã—ã„ã€‚", "answer": "â—‹", "vars": {"order": ["è¨±å¯ãŒå…ˆ", "æ¤œå®šãŒå…ˆ"]}},
                    {"text": "å–¶æ¥­è¨±å¯ã¨å–¶æ¥­æ‰€åŸºæº–ç¢ºèªã®é †åºã¯{{order}}ãŒæ­£ã—ã„ã€‚", "answer": "â—‹", "vars": {"order": ["åŸºæº–ç¢ºèªãŒå…ˆ", "ç”³è«‹ãŒå…ˆ"]}}
                ],
                "éŠæŠ€æ©Ÿã®èªå®š": [
                    {"text": "ä¸­å¤æ©Ÿè¨­ç½®ã¨å‹å¼æ¤œå®šç”³è«‹ã®é †åºã¯{order}ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"order": ["æ¤œå®šç”³è«‹ãŒå…ˆ", "è¨­ç½®ãŒå…ˆ"]}}
                ]
            },
            5: {  # æ™‚ç³»åˆ—ç†è§£ - 18å€‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                "å–¶æ¥­è¨±å¯": [
                    {"text": "å–¶æ¥­é–‹å§‹ã‹ã‚‰{period}å¹´å¾Œã«è¨±å¯æ›´æ–°ç”³è«‹ãŒå¿…è¦ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"period": [3, 5]}},
                    {"text": "å‹å¼æ¤œå®šåˆæ ¼ã‹ã‚‰{period}å¹´ã§æ›´æ–°ç”³è«‹ã®å¯¾è±¡ã¨ãªã‚‹ã€‚", "answer": "â—‹", "vars": {"period": [3, 5]}},
                    {"text": "è¨±å¯ç”³è«‹ã‹ã‚‰è¨±å¯äº¤ä»˜ã¾ã§ã¯é€šå¸¸{days}æ—¥ç¨‹åº¦ã‚’è¦ã™ã‚‹ã€‚", "answer": "â—‹", "vars": {"days": [30, 60, 90]}},
                    {"text": "å–¶æ¥­æ‰€ã®å¤‰æ›´å±Šã¯{timing}ã«æå‡ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"timing": ["å®Ÿæ–½å‰", "å¤‰æ›´å¾Œ"]}}
                ],
                "éŠæŠ€æ©Ÿã®èªå®š": [
                    {"text": "å‹å¼æ¤œå®šæ›´æ–°ç”³è«‹ã¯æœ‰åŠ¹æœŸé™ã®{days}æ—¥å‰ã‹ã‚‰å—ä»˜ã•ã‚Œã‚‹ã€‚", "answer": "â—‹", "vars": {"days": [30, 60, 90]}}
                ]
            },
            6: {  # ã‚·ãƒŠãƒªã‚ªåˆ¤å®š - 25å€‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                "å–¶æ¥­è¨±å¯": [
                    {"text": "AãŒå–¶æ¥­è¨±å¯ã‚’å–å¾—ã—ã€å–¶æ¥­æ‰€ã®ä½ç½®ã‚’å¤‰æ›´ã—ãŸãŒå½¢å¼å¤‰æ›´ã¾ã§{{action}}ã€‚ã“ã®å ´åˆ{{conclusion}}ã€‚", "answer": "â—‹", "vars": {"action": ["ã—ã¦ã„ãªã„"], "conclusion": ["ä¸æ­£å–¶æ¥­ã«ãªã‚‹"]}},
                    {"text": "BãŒè¨±å¯æœŸé–“ä¸­ã«{{violation}}ã—ãŸãŸã‚å–¶æ¥­åœæ­¢å‘½ä»¤ã‚’å—ã‘ãŸã€‚ã“ã®å ´åˆã€å†åº¦å–¶æ¥­ã‚’é–‹å§‹ã™ã‚‹ã«ã¯{{solution}}ã€‚", "answer": "â—‹", "vars": {"violation": ["é•åè¡Œç‚º"], "solution": ["æ–°è¨±å¯ç”³è«‹ãŒå¿…è¦"]}},
                    {"text": "CãŒå‹å¼æ¤œå®šæœŸé–“ä¸­ã«{{action}}å ´åˆã€{{consequence}}ã€‚", "answer": "â—‹", "vars": {"action": ["æ©Ÿæ¢°ã‚’ç„¡æ–­æ”¹é€ ã—ãŸ"], "consequence": ["èªå®šãŒå–ã‚Šæ¶ˆã•ã‚Œã‚‹"]}}
                ],
                "æ™¯å“è¦åˆ¶": [
                    {"text": "DãŒæ³•å®šä¸Šé™ã‚’è¶…ãˆã‚‹æ™¯å“ã‚’æ”¯çµ¦ã—ãŸå ´åˆã€{{penalty}}ã€‚", "answer": "â—‹", "vars": {"penalty": ["ç½°é‡‘ã«å‡¦ã›ã‚‰ã‚Œã‚‹", "å–¶æ¥­åœæ­¢ãŒã‚ã‚‹"]}}
                ]
            },
            7: {  # è¤‡åˆé•å - 12å€‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                "å–¶æ¥­è¨±å¯": [
                    {"text": "å–¶æ¥­è¨±å¯é•åã¨{{other_violation}}ã‚’åŒæ™‚ã«çŠ¯ã—ãŸå ´åˆã€ã‚ˆã‚Šé‡ã„ç½°å‰‡ãŒé©ç”¨ã•ã‚Œã‚‹ã€‚", "answer": "â—‹", "vars": {"other_violation": ["å‹å¼æ¤œå®šé•å", "æ™¯å“è¦åˆ¶é•å"]}},
                    {"text": "è¤‡æ•°ã®è¦åˆ¶é•åãŒã‚ã‚‹å ´åˆã€{{consequence}}ãŒå¯èƒ½ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"consequence": ["å–¶æ¥­è¨±å¯å–ã‚Šæ¶ˆã—", "å–¶æ¥­åœæ­¢"]}}
                ]
            },
            8: {  # æ•°å€¤æ­£ç¢ºæ€§ - 15å€‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                "å–¶æ¥­è¨±å¯": [
                    {"text": "å–¶æ¥­è¨±å¯ã®æœ‰åŠ¹æœŸé™ã¯æ­£ç¢ºã«{period}å¹´ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"period": [3, 5]}},
                    {"text": "å‹å¼æ¤œå®šã®æœ‰åŠ¹æœŸé™ã¯{period}å¹´ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"period": [3, 5]}},
                    {"text": "å–¶æ¥­æ‰€ã¯å­¦æ ¡ã‹ã‚‰æœ€ä½{distance}mä»¥ä¸Šé›¢ã‚Œã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"distance": [100, 200, 500]}},
                    {"text": "æ™¯å“ã®æœ€é«˜æ”¯çµ¦é¡ã¯{amount}å††ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"amount": [10000, 20000, 50000]}}
                ]
            },
            9: {  # ç†ç”±ç†è§£ - 10å€‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                "å–¶æ¥­è¨±å¯": [
                    {"text": "å–¶æ¥­æ‰€åŸºæº–ãŒå³æ ¼ã«å®šã‚ã‚‰ã‚Œã¦ã„ã‚‹ç†ç”±ã¯{{reason}}ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"reason": ["åˆ©ç”¨å®¢ä¿è­·", "ä¸æ­£é˜²æ­¢"]}},
                    {"text": "å‹å¼æ¤œå®šãŒå¿…é ˆã¨ã•ã‚Œã‚‹ã®ã¯{{reason}}ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"reason": ["æ©Ÿæ¢°ã®å®‰å…¨ç¢ºä¿", "åˆ©ç›Šä¿è­·"]}}
                ]
            },
            10: {  # çµŒé¨“é™¥é˜± - 8å€‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                "å–¶æ¥­è¨±å¯": [
                    {"text": "å®Ÿå‹™ã§ã¯å–¶æ¥­è¨±å¯ã¨å‹å¼æ¤œå®šã®æ›´æ–°ã¯åŒæ™‚ã«è¡Œã†å ´åˆãŒå¤šã„ãŒã€æ³•åˆ¶ä¸Šã¯{{answer}}ã€‚", "answer": "â—‹"},
                    {"text": "å–¶æ¥­æ‰€ãŒå®Ÿéš›ã«ç¨¼åƒã—ã¦ã„ãªã„å ´åˆã§ã‚‚ã€è¨±å¯ã®æœ‰åŠ¹æœŸé™ã¯{{status}}ã€‚", "answer": "â—‹", "vars": {"status": ["é€²è¡Œä¸­ã§ã‚ã‚‹", "ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹"]}}
                ]
            },
            11: {  # æ”¹æ­£å¯¾å¿œ - 6å€‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                "å–¶æ¥­è¨±å¯": [
                    {"text": "2020å¹´ã®æ”¹æ­£ã«ã‚ˆã‚Š{{change}}ãŒæ–°ãŸã«å°å…¥ã•ã‚ŒãŸã€‚", "answer": "â—‹", "vars": {"change": ["ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç”³è«‹", "æœŸé™å»¶é•·åˆ¶åº¦"]}},
                    {"text": "æœ€è¿‘ã®æ³•æ”¹æ­£ã§{{change}}ã®è¦å®šãŒç·©å’Œã•ã‚ŒãŸã€‚", "answer": "â—‹", "vars": {"change": ["ç”³è«‹æ›¸é¡", "å–¶æ¥­æ™‚é–“"]}}
                ]
            },
            12: {  # è¤‡åˆå¿œç”¨ - 10å€‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                "å–¶æ¥­è¨±å¯": [
                    {"text": "å–¶æ¥­è¨±å¯å–å¾—â†’å–¶æ¥­æ‰€å¤‰æ›´â†’å‹å¼æ¤œå®šæ›´æ–°â†’æ™¯å“è¦åˆ¶éµå®ˆã¨ã„ã†ä¸€é€£ã®æµã‚Œã§ã€æœ€åˆã«å¯¾å¿œã™ã¹ãã¯{{answer}}ã§ã‚ã‚‹ã€‚", "answer": "â—‹", "vars": {"answer": ["å–¶æ¥­è¨±å¯ã®å¤‰æ›´å±Š"]}},
                    {"text": "æ–°åº—èˆ—é–‹è¨­æ™‚ã«å¿…è¦ãªæ‰‹ç¶šãã‚’{{procedure}}ã®é †ã§å®Ÿæ–½ã™ã‚‹ã®ãŒæ­£ã—ã„ã€‚", "answer": "â—‹", "vars": {"procedure": ["è¨±å¯ç”³è«‹â†’å–¶æ¥­æ‰€è¨­å–¶â†’æ©Ÿæ¢°å°å…¥", "å–¶æ¥­æ‰€è¨­å–¶â†’è¨±å¯ç”³è«‹â†’æ¤œå®šç”³è«‹"]}}
                ]
            }
        }

    def generate_problems(self, target_count: int = 500) -> List[Dict]:
        """ç›®æ¨™æ•°ã®å•é¡Œã‚’ç”Ÿæˆ"""
        print(f"ğŸ¯ {target_count}å•ã®å•é¡Œã‚’ç”Ÿæˆé–‹å§‹...")

        # ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã®ç”Ÿæˆæ•°ã‚’è¨ˆç®—
        pattern_distribution = {}
        for pattern_id, pattern in self.patterns.items():
            count = int(target_count * pattern["weight"])
            pattern_distribution[pattern_id] = count

        # ã‚«ãƒ†ã‚´ãƒªæ•°ã‚’è¨ˆç®—
        category_count = len(self.categories)
        category_list = list(self.categories.keys())
        max_attempts = target_count * 3  # ãƒªãƒˆãƒ©ã‚¤ä¸Šé™

        attempt_count = 0
        # ã‚«ãƒ†ã‚´ãƒªã”ã¨ãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³ã”ã¨ã«ç”Ÿæˆ
        for pattern_id in sorted(self.patterns.keys()):
            total_for_pattern = pattern_distribution[pattern_id]

            for i in range(total_for_pattern):
                category = category_list[i % category_count]

                # é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚è¤‡æ•°å›è©¦è¡Œ
                retry_count = 0
                while retry_count < 5 and attempt_count < max_attempts:
                    problem = self._generate_single_problem(category, pattern_id)
                    attempt_count += 1

                    if problem and problem['problem_text'] not in self.generated_texts:
                        self.problems.append(problem)
                        self.generated_texts.add(problem['problem_text'])
                        break

                    # åˆ¥ã®ã‚«ãƒ†ã‚´ãƒªã‚’è©¦ã™
                    category = category_list[(i + retry_count) % category_count]
                    retry_count += 1

        print(f"âœ… ç”Ÿæˆå®Œäº†: {len(self.problems)}å•ï¼ˆé‡è¤‡æ’é™¤æ¸ˆã¿ï¼‰")
        print(f"ğŸ“Š è©¦è¡Œå›æ•°: {attempt_count}å›")
        return self.problems

    def _generate_single_problem(self, category: str, pattern_id: int) -> Optional[Dict]:
        """å˜ä¸€å•é¡Œã‚’ç”Ÿæˆ"""
        pattern = self.patterns[pattern_id]
        templates = self.problem_templates.get(pattern_id, {}).get(category, [])

        # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒãªã„å ´åˆã€åˆ¥ã®ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ç”Ÿæˆ
        if not templates:
            for alt_category in self.categories.keys():
                alt_templates = self.problem_templates.get(pattern_id, {}).get(alt_category, [])
                if alt_templates:
                    templates = alt_templates
                    break

        if not templates:
            return None

        template = random.choice(templates)

        problem = {
            'problem_id': self.problem_id_counter,
            'pattern_id': pattern_id,
            'pattern_name': pattern['name'],
            'category': category,
            'difficulty': pattern['difficulty'],
            'problem_type': 'true_false',
            'format': 'â—‹Ã—',
            'generated_at': datetime.now().isoformat()
        }

        # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‚’å‡¦ç†
        text = template['text']
        if 'vars' in template:
            for var_name, var_values in template['vars'].items():
                value = random.choice(var_values)
                text = text.replace(f"{{{var_name}}}", str(value))

        problem['problem_text'] = text
        problem['correct_answer'] = template['answer']
        problem['explanation'] = template.get('explanation', f"{category}ã«é–¢ã™ã‚‹{pattern['name']}å•é¡Œã§ã™ã€‚")

        self.problem_id_counter += 1
        return problem

    def save_problems(self, output_file: str):
        """å•é¡Œã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜"""
        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(self.problems, f, ensure_ascii=False, indent=2)
        print(f"ğŸ“ ä¿å­˜å®Œäº†: {output_file}")
        print(f"ğŸ“Š çµ±è¨ˆ: åˆè¨ˆ {len(self.problems)} å•")

if __name__ == "__main__":
    generator = ProblemsGeneratorV2Fixed()
    problems = generator.generate_problems(target_count=500)
    generator.save_problems('/home/planj/patshinko-exam-app/backend/problems_driving_logic_v2_fixed.json')
