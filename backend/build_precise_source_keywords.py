#!/usr/bin/env python3
"""
ソース内容から抽出した正確なキーワード定義
Ultra Think分析結果に基づいた厳密なマッピング
"""

import json
from pathlib import Path

# Ultra Think分析から得られた実際のキーワード
PRECISE_SOURCE_KEYWORDS = {
    # 不正対策（8テーマ）
    "セキュリティアップデート": [
        "日遊協", "取扱主任者証", "販売業者", "登録制度", "更新", "アップデート"
    ],
    "セキュリティ確保": [
        "セキュリティ", "不正行為", "営業所", "点検確認", "保安"
    ],
    "チップのセキュリティ": [
        "チップ", "IC", "ROM", "主基板", "電子部品", "セキュリティ"
    ],
    "不正改造の防止": [
        "不正改造", "改造防止", "主基板", "防止", "対策"
    ],
    "不正検出技術": [
        "検出", "検査", "発見", "立入検査", "点検確認", "検定"
    ],
    "不正行為の罰則": [
        "罰", "罰則", "懲役", "罰金", "処罰", "年以下", "万円以下"
    ],
    "不正防止チェックリスト": [
        "チェックリスト", "点検", "確認事項", "管理", "確認"
    ],
    "不正防止対策要綱": [
        "対策要綱", "ガイドライン", "要綱", "基準", "防止対策"
    ],

    # 営業時間・規制（4テーマ）
    "営業停止命令": [
        "営業停止", "停止命令", "業務停止", "公安委員会", "処分"
    ],
    "営業停止命令の内容": [
        "営業停止命令", "停止内容", "命令内容", "営業停止", "処分内容"
    ],
    "営業停止期間の計算": [
        "停止期間", "期間計算", "日数", "計算方法", "基準期間"
    ],
    "営業禁止時間": [
        "営業禁止", "営業時間", "禁止時間", "深夜", "開始時間", "終了時間"
    ],

    # 営業許可関連（6テーマ）
    "営業許可と営業実績の関係": [
        "営業実績", "リサイクル推進委員会", "廃機回収", "リサイクル選定", "業者選定"
    ],
    "営業許可と型式検定の違い": [
        "型式検定", "違い", "区別", "許可", "相違", "異なる"
    ],
    "営業許可の取消し要件": [
        "取消", "廃止", "失効", "取り消し", "取消事由", "失効要件"
    ],
    "営業許可の失効事由": [
        "失効", "失効事由", "効力喪失", "効力", "再交付", "更新"
    ],
    "営業許可の行政手続き": [
        "申請", "手続き", "申請手続き", "書類", "提出", "申請書"
    ],
    "営業許可は無期限有効": [
        "無期限", "有効期限", "期限なし", "永遠", "有効", "有効期間"
    ],

    # 型式検定関連（5テーマ）
    "遊技機型式検定は3年有効": [
        "型式検定", "3年", "有効期間", "更新", "期限", "有効"
    ],
    "型式検定の申請方法": [
        "型式検定", "申請", "申請方法", "申請書", "手続き", "検定規則"
    ],
    "型式検定と中古機の関係": [
        "中古", "型式検定", "流通", "リユース", "中古機", "旧機械"
    ],
    "型式検定と製造者の責任": [
        "製造者", "型式検定", "責任", "製造業者", "責任", "日工組", "日電協"
    ],
    "型式検定更新申請のタイミング": [
        "更新", "タイミング", "時期", "申請時期", "更新申請", "時間"
    ],

    # 景品規制（5テーマ）
    "リサイクルプロセス": [
        "リサイクル", "再利用", "循環", "リサイクル処理", "回収", "処分"
    ],
    "リサイクル推進法との関係": [
        "リサイクル", "推進法", "循環型", "資源有効利用促進法", "廃棄物"
    ],
    "景品の種類制限": [
        "景品", "種類", "制限", "限定", "範囲", "支給", "景品種類"
    ],
    "景品交換の規制": [
        "景品交換", "交換", "景品", "交換方法", "交換規制", "換金"
    ],
    "賞源有効利用促進法": [
        "賞源", "有効利用", "促進", "促進法", "資源有効利用"
    ],

    # 遊技機管理（13テーマ）
    "中古遊技機の取扱い": [
        "中古", "取扱い", "取扱", "リユース", "中古機", "中古遊技機"
    ],
    "中古遊技機の流通管理": [
        "中古", "流通", "市場", "管理", "流通管理", "中古遊技機"
    ],
    "基板ケースのかしめと管理": [
        "基板", "かしめ", "ケース", "管理", "主基板", "基板ケース"
    ],
    "外部端子板の管理": [
        "外部端子", "端子板", "管理", "接続端子", "端子"
    ],
    "故障遊技機の対応": [
        "故障", "不具合", "対応", "修理", "トラブル", "故障対応"
    ],
    "新台設置の手続き": [
        "新台", "設置", "導入", "手続き", "新規", "設置手続き", "新台設置"
    ],
    "旧機械の回収と廃棄": [
        "回収", "廃棄", "廃棄処分", "旧機械", "撤去", "回収廃棄"
    ],
    "時間帯別営業制限": [
        "時間帯", "営業", "制限", "規制", "営業制限"
    ],
    "設置済み遊技機の交換手続き": [
        "交換", "設置済み", "設置機", "取替", "交換手続き"
    ],
    "遊技機の保守管理": [
        "保守", "管理", "メンテナンス", "維持", "保守管理", "保守点検"
    ],
    "遊技機の点検・保守計画": [
        "点検", "保守計画", "定期点検", "計画", "点検計画", "点検確認"
    ],
    "遊技機の製造番号管理": [
        "製造番号", "管理", "番号", "シリアル", "番号管理"
    ],
    "違反時の行政処分": [
        "違反", "処分", "行政処分", "指導", "警告", "制裁"
    ],
}

def map_to_precise_theme(problem_text: str) -> tuple:
    """問題を厳密なソースキーワードで分析"""

    best_theme = None
    best_score = 0

    for theme_name, keywords in PRECISE_SOURCE_KEYWORDS.items():
        score = 0
        for kw in keywords:
            # 複数キーワードマッチング、より長いキーワードを優先
            if kw in problem_text:
                score += len(kw)

        if score > best_score:
            best_score = score
            best_theme = theme_name

    if not best_theme:
        best_theme = "新台設置の手続き"

    # カテゴリ決定
    category_map = {
        "セキュリティアップデート": "不正対策",
        "セキュリティ確保": "不正対策",
        "チップのセキュリティ": "不正対策",
        "不正改造の防止": "不正対策",
        "不正検出技術": "不正対策",
        "不正行為の罰則": "不正対策",
        "不正防止チェックリスト": "不正対策",
        "不正防止対策要綱": "不正対策",

        "営業停止命令": "営業時間・規制",
        "営業停止命令の内容": "営業時間・規制",
        "営業停止期間の計算": "営業時間・規制",
        "営業禁止時間": "営業時間・規制",

        "営業許可と営業実績の関係": "営業許可関連",
        "営業許可と型式検定の違い": "営業許可関連",
        "営業許可の取消し要件": "営業許可関連",
        "営業許可の失効事由": "営業許可関連",
        "営業許可の行政手続き": "営業許可関連",
        "営業許可は無期限有効": "営業許可関連",

        "遊技機型式検定は3年有効": "型式検定関連",
        "型式検定の申請方法": "型式検定関連",
        "型式検定と中古機の関係": "型式検定関連",
        "型式検定と製造者の責任": "型式検定関連",
        "型式検定更新申請のタイミング": "型式検定関連",

        "リサイクルプロセス": "景品規制",
        "リサイクル推進法との関係": "景品規制",
        "景品の種類制限": "景品規制",
        "景品交換の規制": "景品規制",
        "賞源有効利用促進法": "景品規制",

        "中古遊技機の取扱い": "遊技機管理",
        "中古遊技機の流通管理": "遊技機管理",
        "基板ケースのかしめと管理": "遊技機管理",
        "外部端子板の管理": "遊技機管理",
        "故障遊技機の対応": "遊技機管理",
        "新台設置の手続き": "遊技機管理",
        "旧機械の回収と廃棄": "遊技機管理",
        "時間帯別営業制限": "遊技機管理",
        "設置済み遊技機の交換手続き": "遊技機管理",
        "遊技機の保守管理": "遊技機管理",
        "遊技機の点検・保守計画": "遊技機管理",
        "遊技機の製造番号管理": "遊技機管理",
        "違反時の行政処分": "遊技機管理",
    }

    category = category_map.get(best_theme, "遊技機管理")
    return category, best_theme, best_score

def create_precise_mapping():
    """厳密なソースキーワードで500問をマッピング"""

    with open('backend/problems_final_500_complete.json', 'r') as f:
        problems = json.load(f)

    remapped = []
    distribution = {}
    theme_dist = defaultdict(int)
    unmatched = []

    print("【厳密なソースキーワード再マッピング中...】\n")

    for p in problems:
        problem_text = p.get('problem_text', '')
        category, theme, score = map_to_precise_theme(problem_text)

        p['verified_category'] = category
        p['verified_theme'] = theme
        p['keyword_match_score'] = score

        remapped.append(p)

        if category not in distribution:
            distribution[category] = 0
        distribution[category] += 1

        theme_dist[theme] += 1

        if score == 0:
            unmatched.append(problem_text[:50])

    # 出力
    with open('backend/problems_500_precise_verified.json', 'w') as f:
        json.dump(remapped, f, indent=2, ensure_ascii=False)

    print("✅ 厳密なソースキーワード再マッピング完了\n")
    print("【カテゴリ別分布】\n")

    for cat in sorted(distribution.keys()):
        count = distribution[cat]
        pct = (count / 500) * 100
        print(f"  {cat:20} {count:3}問 ({pct:5.1f}%)")

    print(f"\n【特に注目: 営業許可関連の詳細】\n")
    for theme in sorted(theme_dist.keys()):
        if "営業許可" in theme:
            count = theme_dist[theme]
            pct = (count / 500) * 100
            print(f"  {theme:40} {count:3}問 ({pct:5.1f}%)")

    if unmatched:
        print(f"\n⚠️  キーワードマッチなし: {len(unmatched)}問")
        print(f"  サンプル:")
        for text in unmatched[:3]:
            print(f"    - {text}...")

from collections import defaultdict

if __name__ == "__main__":
    create_precise_mapping()
