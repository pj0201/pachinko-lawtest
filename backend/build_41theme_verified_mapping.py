#!/usr/bin/env python3
"""
ソース検証に基づく41テーマ検証済みマッピング
両ソースに実際に存在するテーマのみを使用
"""

import json
from typing import Tuple

# ソース検証に基づいた実際に存在するテーマのキーワードマッピング
VERIFIED_41_THEMES = {
    # 不正対策（8テーマ - 検証済み）
    "セキュリティアップデート": ["セキュリティアップデート", "更新", "バージョン", "パッチ"],
    "セキュリティ確保": ["セキュリティ確保", "セキュリティ", "保安", "防犯", "監視"],
    "チップのセキュリティ": ["チップ", "IC", "ROM", "セキュリティ"],
    "不正改造の防止": ["不正改造", "改造防止", "防止", "対策"],
    "不正検出技術": ["検出", "検査", "発見", "検知", "検証"],
    "不正行為の罰則": ["罰", "罰則", "懲役", "罰金", "処罰"],
    "不正防止チェックリスト": ["チェックリスト", "点検", "確認", "項目"],
    "不正防止対策要綱": ["対策要綱", "ガイドライン", "要綱", "基準"],

    # 営業時間・規制（4テーマ - 実際の構成）
    "営業停止命令": ["営業停止", "停止命令", "業務停止"],
    "営業停止命令の内容": ["営業停止", "停止内容", "命令内容"],
    "営業停止期間の計算": ["停止期間", "期間計算", "日数"],
    "営業禁止時間": ["営業禁止", "営業時間", "禁止時間", "深夜"],

    # 営業許可関連（6テーマ - 実際の構成）
    "営業許可と営業実績の関係": ["営業実績", "営業", "実績"],
    "営業許可と型式検定の違い": ["違い", "区別", "型式検定"],
    "営業許可の取消し要件": ["取消", "廃止", "失効"],
    "営業許可の失効事由": ["失効", "効力喪失"],
    "営業許可の行政手続き": ["申請", "手続き", "申請手続き"],
    "営業許可は無期限有効": ["無期限", "有効期限", "期限"],

    # 型式検定関連（5テーマ - 実際の構成）
    "遊技機型式検定は3年有効": ["型式検定", "3年", "有効期間", "更新"],
    "型式検定の申請方法": ["型式検定", "申請", "申請方法"],
    "型式検定と中古機の関係": ["中古", "型式検定", "流通"],
    "型式検定と製造者の責任": ["製造者", "型式検定", "責任"],
    "型式検定更新申請のタイミング": ["更新", "タイミング", "時期"],

    # 景品規制（5テーマ - 実際の構成）
    "リサイクルプロセス": ["リサイクル", "再利用", "循環"],
    "リサイクル推進法との関係": ["リサイクル", "推進法", "循環型"],
    "景品の種類制限": ["景品", "種類", "制限"],
    "景品交換の規制": ["景品交換", "交換", "規制"],
    "賞源有効利用促進法": ["賞源", "有効利用", "促進"],

    # 遊技機管理（13テーマ - 実際の構成）
    "中古遊技機の取扱い": ["中古", "取扱い", "リユース"],
    "中古遊技機の流通管理": ["中古", "流通", "管理"],
    "基板ケースのかしめと管理": ["基板", "かしめ", "ケース", "管理"],
    "外部端子板の管理": ["外部端子", "端子板", "管理"],
    "故障遊技機の対応": ["故障", "不具合", "対応"],
    "新台設置の手続き": ["新台", "設置", "導入", "手続き"],
    "旧機械の回収と廃棄": ["回収", "廃棄", "廃棄処分"],
    "時間帯別営業制限": ["時間帯", "営業", "制限"],
    "設置済み遊技機の交換手続き": ["交換", "設置済み", "取替"],
    "遊技機の保守管理": ["保守", "管理", "メンテナンス"],
    "遊技機の点検・保守計画": ["点検", "保守計画", "計画"],
    "遊技機の製造番号管理": ["製造番号", "管理", "番号"],
    "違反時の行政処分": ["違反", "処分", "行政処分"],
}

def analyze_problem_for_verified_theme(problem_text: str) -> Tuple[str, str]:
    """問題テキストを41テーマで分析"""

    best_theme = None
    best_score = 0

    for theme_name, keywords in VERIFIED_41_THEMES.items():
        score = 0
        for kw in keywords:
            if kw in problem_text:
                score += len(kw)

        if score > best_score:
            best_score = score
            best_theme = theme_name

    if not best_theme:
        best_theme = "新台設置の手続き"

    # カテゴリ判定
    theme_to_category = {
        "セキュリティアップデート": "不正対策",
        "セキュリティ確保": "不正対策",
        "チップのセキュリティ": "不正対策",
        "不正改造の防止": "不正対策",
        "不正検出技術": "不正対策",
        "不正行為の罰則": "不正対策",
        "不正防止チェックリスト": "不正対策",
        "不正防止対策要綱": "不正対策",

        "営業停止命令": "営業時間・規制",
        "営業停止命令の内容": "営業時間・規制",
        "営業停止期間の計算": "営業時間・規制",
        "営業禁止時間": "営業時間・規制",

        "営業許可と営業実績の関係": "営業許可関連",
        "営業許可と型式検定の違い": "営業許可関連",
        "営業許可の取消し要件": "営業許可関連",
        "営業許可の失効事由": "営業許可関連",
        "営業許可の行政手続き": "営業許可関連",
        "営業許可は無期限有効": "営業許可関連",

        "遊技機型式検定は3年有効": "型式検定関連",
        "型式検定の申請方法": "型式検定関連",
        "型式検定と中古機の関係": "型式検定関連",
        "型式検定と製造者の責任": "型式検定関連",
        "型式検定更新申請のタイミング": "型式検定関連",

        "リサイクルプロセス": "景品規制",
        "リサイクル推進法との関係": "景品規制",
        "景品の種類制限": "景品規制",
        "景品交換の規制": "景品規制",
        "賞源有効利用促進法": "景品規制",

        "中古遊技機の取扱い": "遊技機管理",
        "中古遊技機の流通管理": "遊技機管理",
        "基板ケースのかしめと管理": "遊技機管理",
        "外部端子板の管理": "遊技機管理",
        "故障遊技機の対応": "遊技機管理",
        "新台設置の手続き": "遊技機管理",
        "旧機械の回収と廃棄": "遊技機管理",
        "時間帯別営業制限": "遊技機管理",
        "設置済み遊技機の交換手続き": "遊技機管理",
        "遊技機の保守管理": "遊技機管理",
        "遊技機の点検・保守計画": "遊技機管理",
        "遊技機の製造番号管理": "遊技機管理",
        "違反時の行政処分": "遊技機管理",
    }

    category = theme_to_category.get(best_theme, "遊技機管理")

    return category, best_theme

def create_verified_41theme_mapping():
    """500問を41テーマの検証済みマッピングで処理"""

    with open('backend/problems_final_500_complete.json', 'r') as f:
        problems = json.load(f)

    remapped = []
    distribution = {}
    theme_distribution = {}

    print("【41テーマ検証済みマッピング実行中...】\n")

    for p in problems:
        problem_text = p.get('problem_text', '')

        category, theme = analyze_problem_for_verified_theme(problem_text)

        p['verified_category'] = category
        p['verified_theme'] = theme

        remapped.append(p)

        # 統計
        if category not in distribution:
            distribution[category] = 0
        distribution[category] += 1

        if theme not in theme_distribution:
            theme_distribution[theme] = 0
        theme_distribution[theme] += 1

    # 出力
    with open('backend/problems_500_41theme_verified.json', 'w') as f:
        json.dump(remapped, f, indent=2, ensure_ascii=False)

    print("✅ 500問の41テーマ検証済みマッピング完了\n")
    print("【カテゴリ別分布】\n")

    for cat in sorted(distribution.keys()):
        count = distribution[cat]
        pct = (count / 500) * 100
        print(f"  {cat:20} {count:3}問 ({pct:5.1f}%)")

    print(f"\n【テーマ別分布】\n")

    for cat in sorted(distribution.keys()):
        print(f"\n【{cat}】")
        cat_themes = {t: theme_distribution[t] for t in theme_distribution
                      if t in [th for th_cat, themes_list in [
                          ("不正対策", ["セキュリティアップデート", "セキュリティ確保", "チップのセキュリティ",
                                     "不正改造の防止", "不正検出技術", "不正行為の罰則",
                                     "不正防止チェックリスト", "不正防止対策要綱"]),
                          ("営業時間・規制", ["営業停止命令", "営業停止命令の内容", "営業停止期間の計算", "営業禁止時間"]),
                          ("営業許可関連", ["営業許可と営業実績の関係", "営業許可と型式検定の違い",
                                      "営業許可の取消し要件", "営業許可の失効事由",
                                      "営業許可の行政手続き", "営業許可は無期限有効"]),
                          ("型式検定関連", ["遊技機型式検定は3年有効", "型式検定の申請方法",
                                      "型式検定と中古機の関係", "型式検定と製造者の責任",
                                      "型式検定更新申請のタイミング"]),
                          ("景品規制", ["リサイクルプロセス", "リサイクル推進法との関係",
                                  "景品の種類制限", "景品交換の規制", "賞源有効利用促進法"]),
                          ("遊技機管理", ["中古遊技機の取扱い", "中古遊技機の流通管理",
                                    "基板ケースのかしめと管理", "外部端子板の管理",
                                    "故障遊技機の対応", "新台設置の手続き", "旧機械の回収と廃棄",
                                    "時間帯別営業制限", "設置済み遊技機の交換手続き",
                                    "遊技機の保守管理", "遊技機の点検・保守計画",
                                    "遊技機の製造番号管理", "違反時の行政処分"])
                      ] for th in themes_list]}
        for theme, count in sorted(cat_themes.items(), key=lambda x: -x[1]):
            print(f"  {theme:35} {count:3}問")

    print(f"\n合計: 500問")

if __name__ == "__main__":
    create_verified_41theme_mapping()
