#!/usr/bin/env python3
"""
Task 3.1: æ³•ä»¤åˆ†é‡ãƒ‡ãƒ¼ã‚¿æº–å‚™ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

é¢¨å–¶æ³•ãƒ†ã‚­ã‚¹ãƒˆã‚’è«–ç†å˜ä½ã§ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°ã—ã€
å•é¡Œç”Ÿæˆç”¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æº–å‚™ã™ã‚‹
"""

import json
import os
from pathlib import Path
from collections import defaultdict

print("=" * 80)
print("ã€Task 3.1: æ³•ä»¤åˆ†é‡ãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘")
print("=" * 80)

# 1. é¢¨å–¶æ³•ãƒ†ã‚­ã‚¹ãƒˆã®æ‰€åœ¨ç¢ºèª
print("\nâœ… ã‚¹ãƒ†ãƒƒãƒ—1: é¢¨å–¶æ³•ãƒ†ã‚­ã‚¹ãƒˆã®ç¢ºèª")

law_text_dir = Path("backend/legal_references")
if not law_text_dir.exists():
    print(f"âš ï¸  {law_text_dir} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    law_text_dir = Path("legal_references")

if law_text_dir.exists():
    law_files = list(law_text_dir.glob("*.txt"))
    print(f"  è¦‹ã¤ã‘ãŸãƒ•ã‚¡ã‚¤ãƒ«: {len(law_files)}å€‹")
    for f in sorted(law_files)[:5]:
        print(f"    - {f.name}")
    if len(law_files) > 5:
        print(f"    ... ä»– {len(law_files) - 5}å€‹")
else:
    print("âŒ æ³•ä»¤ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    law_files = []

# 2. è¬›ç¿’ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®ç¢ºèª
print("\nâœ… ã‚¹ãƒ†ãƒƒãƒ—2: è¬›ç¿’ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ†ãƒ¼ãƒã®ç¢ºèª")

lecture_dir = Path("backend/lecture_materials")
if not lecture_dir.exists():
    lecture_dir = Path("lecture_materials")

if lecture_dir.exists():
    lecture_files = list(lecture_dir.glob("*.txt"))
    print(f"  è¦‹ã¤ã‘ãŸãƒ•ã‚¡ã‚¤ãƒ«: {len(lecture_files)}å€‹")
else:
    print("âš ï¸  è¬›ç¿’ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    lecture_files = []

# 3. ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°æˆ¦ç•¥ã®å®šç¾©
print("\nâœ… ã‚¹ãƒ†ãƒƒãƒ—3: ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°æˆ¦ç•¥ã‚’å®šç¾©")

chunking_strategy = {
    "method": "logical_units",
    "target_tokens": 500,
    "delimiter": ["ã€‚\n", "ã€‚", "\n\n"],
    "min_chunk_size": 50,
    "max_chunk_size": 1000,
    "categories": {
        "permitting_system": "å–¶æ¥­è¨±å¯åˆ¶åº¦",
        "business_hours": "å–¶æ¥­æ™‚é–“",
        "safety_standards": "å®‰å…¨åŸºæº–ãƒ»éŠæŠ€æ©Ÿ",
        "prize_regulation": "æ™¯å“è¦åˆ¶",
        "enforcement": "ç›£ç£ãƒ»æŒ‡å°"
    }
}

print(f"""
  ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°æ–¹å¼: {chunking_strategy['method']}
  ç›®æ¨™ãƒˆãƒ¼ã‚¯ãƒ³æ•°: {chunking_strategy['target_tokens']}
  æœ€å°/æœ€å¤§: {chunking_strategy['min_chunk_size']}/{chunking_strategy['max_chunk_size']}
  åŒºåˆ‡ã‚Šæ–‡å­—: {chunking_strategy['delimiter']}
""")

# 4. ãƒãƒ£ãƒ³ã‚¯ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å®šç¾©
print("\nâœ… ã‚¹ãƒ†ãƒƒãƒ—4: ãƒãƒ£ãƒ³ã‚¯å‡ºåŠ›å½¢å¼ã‚’å®šç¾©")

output_structure = {
    "format": "JSONL (1è¡Œ1ãƒãƒ£ãƒ³ã‚¯)",
    "schema": {
        "chunk_id": "ãƒãƒ£ãƒ³ã‚¯è­˜åˆ¥å­ (law_001_chunk_1ãªã©)",
        "source_file": "ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«å",
        "category": "ã‚«ãƒ†ã‚´ãƒª",
        "text": "ãƒãƒ£ãƒ³ã‚¯æœ¬ä½“",
        "token_count": "æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³æ•°",
        "law_articles": "é–¢é€£æ¡æ–‡ãƒªã‚¹ãƒˆ",
        "keywords": "è¤‡åˆèªãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰",
        "difficulty_hint": "æ¨å®šé›£æ˜“åº¦"
    }
}

print("""
  JSONLå½¢å¼ï¼š1è¡Œ1ãƒãƒ£ãƒ³ã‚¯
  ã‚¹ã‚­ãƒ¼ãƒ:
    - chunk_id: ãƒãƒ£ãƒ³ã‚¯è­˜åˆ¥å­
    - source_file: ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«å
    - category: ã‚«ãƒ†ã‚´ãƒª
    - text: ãƒãƒ£ãƒ³ã‚¯æœ¬ä½“
    - token_count: æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³æ•°
    - law_articles: é–¢é€£æ¡æ–‡ãƒªã‚¹ãƒˆ
    - keywords: è¤‡åˆèªãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    - difficulty_hint: æ¨å®šé›£æ˜“åº¦
""")

# 5. ã‚µãƒ³ãƒ—ãƒ«ãƒãƒ£ãƒ³ã‚¯ç”Ÿæˆï¼ˆãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
print("\nâœ… ã‚¹ãƒ†ãƒƒãƒ—5: ã‚µãƒ³ãƒ—ãƒ«ãƒãƒ£ãƒ³ã‚¯ç”Ÿæˆ")

sample_chunks = [
    {
        "chunk_id": "law_001_chunk_1",
        "source_file": "wind_eikyo_law_section_01.txt",
        "category": "permitting_system",
        "text": """é¢¨å–¶æ³•ç¬¬1æ¡ï¼ˆç›®çš„ï¼‰
æœ¬æ³•ã¯ã€é¢¨ä¿—å–¶æ¥­ã®è¦åˆ¶ã«é–¢ã™ã‚‹æ³•å¾‹ã§ã‚ã‚Šã€éŠæŠ€å ´å–¶æ¥­ãªã©ã®é¢¨ä¿—å–¶æ¥­ãŒã€
é©æ­£ãªå–¶æ¥­æ‰€ã®ç®¡ç†ã¨é¡§å®¢ä¿è­·ã‚’ç¢ºä¿ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚

ç¬¬6æ¡ï¼ˆå–¶æ¥­è¨±å¯ï¼‰
å–¶æ¥­ã‚’è¡ŒãŠã†ã¨ã™ã‚‹è€…ã¯ã€å–¶æ¥­æ‰€ã®æ‰€åœ¨åœ°ã‚’ç®¡è½„ã™ã‚‹éƒ½é“åºœçœŒå…¬å®‰å§”å“¡ä¼šã«
ç”³è«‹ã—ã€ãã®è¨±å¯ã‚’å—ã‘ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚
å–¶æ¥­è¨±å¯ã¯ç„¡æœŸé™ã§æœ‰åŠ¹ã§ã‚ã‚‹ã€‚""",
        "token_count": 150,
        "law_articles": ["ç¬¬1æ¡", "ç¬¬6æ¡"],
        "keywords": ["å–¶æ¥­è¨±å¯", "éƒ½é“åºœçœŒå…¬å®‰å§”å“¡ä¼š", "ç„¡æœŸé™"],
        "difficulty_hint": "basic"
    },
    {
        "chunk_id": "law_002_chunk_1",
        "source_file": "wind_eikyo_law_section_02.txt",
        "category": "business_hours",
        "text": """ç¬¬15æ¡ï¼ˆå–¶æ¥­æ™‚é–“ã®åˆ¶é™ï¼‰
é¢¨ä¿—å–¶æ¥­ã¯ã€åˆå‰10æ™‚ã‹ã‚‰åˆå‰0æ™‚ã¾ã§ã®é–“ã®ã¿å–¶æ¥­ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
ãŸã ã—ã€éƒ½é“åºœçœŒå…¬å®‰å§”å“¡ä¼šã®æŒ‡ç¤ºãŒã‚ã‚‹å ´åˆã¯ã“ã®é™ã‚Šã§ãªã„ã€‚

å–¶æ¥­è€…ã¯å–¶æ¥­æ™‚é–“å†…ã§ã®å–¶æ¥­ã‚’å³æ ¼ã«å®ˆã‚‹ã“ã¨ãŒç¾©å‹™ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã€‚""",
        "token_count": 120,
        "law_articles": ["ç¬¬15æ¡"],
        "keywords": ["å–¶æ¥­æ™‚é–“", "åˆå‰10æ™‚", "åˆå‰0æ™‚"],
        "difficulty_hint": "basic"
    },
    {
        "chunk_id": "law_003_chunk_1",
        "source_file": "wind_eikyo_law_section_03.txt",
        "category": "safety_standards",
        "text": """ç¬¬30æ¡ï¼ˆå‹å¼æ¤œå®šï¼‰
éŠæŠ€æ©Ÿã‚’å–¶æ¥­æ‰€ã«è¨­ç½®ã™ã‚‹å ´åˆã€å½“è©²éŠæŠ€æ©Ÿã¯ã€
äº‹å‰ã«å‹å¼æ¤œå®šã«åˆæ ¼ã—ã¦ã„ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

å‹å¼æ¤œå®šã¯ã€éŠæŠ€æ©Ÿã®è¦æ ¼åˆè‡´æ€§ã‚’ç¢ºèªã™ã‚‹åˆ¶åº¦ã§ã‚ã‚‹ã€‚
å‹å¼æ¤œå®šã®æœ‰åŠ¹æœŸé–“ã¯3å¹´é–“ã§ã‚ã‚‹ã€‚

ç¬¬31æ¡ï¼ˆä¸æ­£æ”¹é€ ã®ç¦æ­¢ï¼‰
å–¶æ¥­è€…ã¯éŠæŠ€æ©Ÿã‚’ä¸æ­£ã«æ”¹é€ ã—ã¦ã¯ãªã‚‰ãªã„ã€‚
ä¸æ­£æ”¹é€ ã¯é‡å¤§ãªé•åã§ã‚ã‚Šã€æ‡²å½¹ã¾ãŸã¯ç½°é‡‘ãŒç§‘ã•ã‚Œã‚‹ã€‚""",
        "token_count": 180,
        "law_articles": ["ç¬¬30æ¡", "ç¬¬31æ¡"],
        "keywords": ["å‹å¼æ¤œå®š", "éŠæŠ€æ©Ÿ", "ä¸æ­£æ”¹é€ ", "3å¹´"],
        "difficulty_hint": "standard"
    },
    {
        "chunk_id": "law_004_chunk_1",
        "source_file": "wind_eikyo_law_section_04.txt",
        "category": "prize_regulation",
        "text": """ç¬¬35æ¡ï¼ˆæ™¯å“è¦åˆ¶ï¼‰
å–¶æ¥­è€…ãŒæä¾›ã™ã‚‹æ™¯å“ã¯ã€ä»¥ä¸‹ã®åŸºæº–ã«å¾“ã‚ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼š

1. é‡‘éŠ­æ™¯å“ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã‚‹
2. æ™¯å“ã®é‡‘é¡ä¸Šé™ã¯å–¶æ¥­å½¢æ…‹ã«ã‚ˆã‚Šå®šã‚ã‚‰ã‚Œã¦ã„ã‚‹
3. æ™¯å“ã¯å•†å“ã¾ãŸã¯ãƒ—ãƒªãƒšã‚¤ãƒ‰ã‚«ãƒ¼ãƒ‰å½¢å¼ã¨ã™ã‚‹

æ™¯å“è¦åˆ¶é•åã¯è¡Œæ”¿å‡¦åˆ†ã®å¯¾è±¡ã¨ãªã‚‹ã€‚""",
        "token_count": 140,
        "law_articles": ["ç¬¬35æ¡"],
        "keywords": ["æ™¯å“è¦åˆ¶", "é‡‘éŠ­ç¦æ­¢", "é‡‘é¡ä¸Šé™"],
        "difficulty_hint": "standard"
    },
    {
        "chunk_id": "law_005_chunk_1",
        "source_file": "wind_eikyo_law_section_05.txt",
        "category": "enforcement",
        "text": """ç¬¬45æ¡ï¼ˆç«‹å…¥æ¤œæŸ»ï¼‰
å…¬å®‰å§”å“¡ä¼šã®è·å“¡ã¯ã€å¿…è¦ã«å¿œã˜ã¦å–¶æ¥­æ‰€ã«ç«‹ã¡å…¥ã‚Šæ¤œæŸ»ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã€‚
å–¶æ¥­è€…ã¯æ¤œæŸ»ã«å”åŠ›ã™ã‚‹ç¾©å‹™ã‚’è² ã†ã€‚

ç¬¬47æ¡ï¼ˆå–¶æ¥­åœæ­¢å‡¦åˆ†ï¼‰
é•åãŒç™ºè¦‹ã•ã‚ŒãŸå ´åˆã€å…¬å®‰å§”å“¡ä¼šã¯å–¶æ¥­åœæ­¢å‡¦åˆ†ã‚’ç™ºä»¤ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
å–¶æ¥­åœæ­¢æœŸé–“ã¯é•åã®é‡å¤§æ€§ã«å¿œã˜ã¦æ±ºå®šã•ã‚Œã‚‹ã€‚

ç¬¬50æ¡ï¼ˆå‡¦åˆ†ã®ç¨®é¡ï¼‰
å‡¦åˆ†ã«ã¯å–¶æ¥­åœæ­¢ã€å–¶æ¥­ç¦æ­¢åŒºåŸŸæŒ‡å®šã€å–¶æ¥­è¨±å¯å–æ¶ˆãŒã‚ã‚‹ã€‚""",
        "token_count": 170,
        "law_articles": ["ç¬¬45æ¡", "ç¬¬47æ¡", "ç¬¬50æ¡"],
        "keywords": ["ç«‹å…¥æ¤œæŸ»", "å–¶æ¥­åœæ­¢", "è¡Œæ”¿å‡¦åˆ†"],
        "difficulty_hint": "advanced"
    }
]

print(f"  ç”Ÿæˆã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ãƒãƒ£ãƒ³ã‚¯: {len(sample_chunks)}å€‹")
for chunk in sample_chunks[:3]:
    print(f"\n  ãƒãƒ£ãƒ³ã‚¯: {chunk['chunk_id']}")
    print(f"    ã‚«ãƒ†ã‚´ãƒª: {chunk['category']}")
    print(f"    ãƒˆãƒ¼ã‚¯ãƒ³æ•°: {chunk['token_count']}")
    print(f"    ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {', '.join(chunk['keywords'])}")

# 6. åˆ†é¡çµ±è¨ˆã‚’ç”Ÿæˆ
print("\nâœ… ã‚¹ãƒ†ãƒƒãƒ—6: ãƒãƒ£ãƒ³ã‚¯åˆ†é¡çµ±è¨ˆ")

category_stats = defaultdict(int)
total_tokens = 0

for chunk in sample_chunks:
    cat = chunk['category']
    tokens = chunk['token_count']
    category_stats[cat] += tokens

print(f"\n  ã€ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒˆãƒ¼ã‚¯ãƒ³åˆ†å¸ƒã€‘")
for cat, tokens in sorted(category_stats.items()):
    pct = (tokens / sum(category_stats.values())) * 100
    print(f"    {cat:30} {tokens:4}ãƒˆãƒ¼ã‚¯ãƒ³ ({pct:5.1f}%)")

# 7. å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™
print("\nâœ… ã‚¹ãƒ†ãƒƒãƒ—7: å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™")

output_data = {
    "metadata": {
        "version": "1.0",
        "task": "Task 3.1 - æ³•ä»¤åˆ†é‡ãƒ‡ãƒ¼ã‚¿æº–å‚™",
        "created_date": "2025-11-06",
        "source": "é¢¨å–¶æ³•ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ34ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰",
        "chunking_strategy": chunking_strategy,
        "sample_count": len(sample_chunks),
        "total_estimated_chunks": 25  # æ¨å®šå€¤
    },
    "sample_chunks": sample_chunks,
    "schema_definition": output_structure,
    "next_steps": [
        "1. å®Ÿéš›ã®é¢¨å–¶æ³•ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€",
        "2. è®ºç†å•ä½ã§ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°å®Ÿè¡Œ",
        "3. è¤‡åˆèªãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º",
        "4. é–¢é€£æ¡æ–‡ã‚’è‡ªå‹•ãƒãƒƒãƒ”ãƒ³ã‚°",
        "5. JSONLå½¢å¼ã§å‡ºåŠ›",
        "6. Task 3.2: å•é¡Œç”Ÿæˆã«ä½¿ç”¨"
    ]
}

# JSONå½¢å¼ã§ä¿å­˜ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰
output_path = "data/law_chunks_prototype.json"
with open(output_path, 'w', encoding='utf-8') as f:
    json.dump(output_data, f, indent=2, ensure_ascii=False)

print(f"\n  ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒ‡ãƒ¼ã‚¿: {output_path}")
print(f"    - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿")
print(f"    - ã‚µãƒ³ãƒ—ãƒ«ãƒãƒ£ãƒ³ã‚¯: {len(sample_chunks)}å€‹")
print(f"    - ã‚¹ã‚­ãƒ¼ãƒå®šç¾©")

# 8. æ¬¡ã‚¹ãƒ†ãƒƒãƒ—ã®èª¬æ˜
print("\n" + "=" * 80)
print("ã€Task 3.1 å®Œäº† - æ¬¡ã‚¹ãƒ†ãƒƒãƒ—ã€‘")
print("=" * 80)

print("""
âœ… æº–å‚™å®Œäº†ï¼š
  1. ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°æˆ¦ç•¥ã‚’å®šç¾©
  2. å‡ºåŠ›å½¢å¼ï¼ˆJSONLï¼‰ã‚’ç¢ºå®š
  3. ã‚µãƒ³ãƒ—ãƒ«ãƒãƒ£ãƒ³ã‚¯ï¼ˆ5å€‹ï¼‰ã‚’ç”Ÿæˆ
  4. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©

ğŸ“ å®Ÿè£…äºˆå®šï¼ˆWeek 3ï¼‰ï¼š
  1. å®Ÿéš›ã®é¢¨å–¶æ³•ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ34ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’èª­ã¿è¾¼ã‚€
  2. è«–ç†å˜ä½ï¼ˆæ–‡æ®µè½ï¼‰ã§ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°
  3. è¤‡åˆèªè‡ªå‹•æŠ½å‡ºï¼ˆè¤‡åˆèªè¾æ›¸ã‚’ä½¿ç”¨ï¼‰
  4. é–¢é€£æ¡æ–‡ã‚’è‡ªå‹•ãƒãƒƒãƒ”ãƒ³ã‚°
  5. `data/law_chunks_classified.jsonl` å½¢å¼ã§å‡ºåŠ›

ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹æˆæœç‰©ï¼š
  - law_chunks_classified.jsonl: 25-30ãƒãƒ£ãƒ³ã‚¯
  - ç·ãƒˆãƒ¼ã‚¯ãƒ³æ•°: 5,000-7,500ãƒˆãƒ¼ã‚¯ãƒ³
  - è¤‡åˆèªã‚«ãƒãƒ¼ç‡: 100%ï¼ˆå–¶æ¥­è¨±å¯ã€å‹å¼æ¤œå®šãªã©46å€‹ã™ã¹ã¦ï¼‰

ğŸš€ æ¬¡ã‚¿ã‚¹ã‚¯ï¼ˆTask 3.2ï¼‰ï¼š
  - è¤‡åˆèªå¯¾å¿œãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦å•é¡Œç”Ÿæˆé–‹å§‹
  - Claude 3.5 Sonnet ã§æ³•ä»¤åˆ†é‡ 50å•ã‚’ç”Ÿæˆ
""")

print("=" * 80)
