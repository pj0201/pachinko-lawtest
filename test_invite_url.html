<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>招待URL制限テスト</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
        button { margin: 5px; padding: 10px; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>招待URL制限テスト</h1>

    <div class="info">
        <h3>テストシナリオ</h3>
        <ol>
            <li>TEST_001_ABC123 で登録 → 成功</li>
            <li>同じ TEST_001_ABC123 で再登録 → エラー（使用済み）</li>
            <li>TEST_002_DEF456 で登録 → 成功（別トークン）</li>
            <li>トークンなし → エラー</li>
        </ol>
    </div>

    <button onclick="clearAll()">全データクリア（テスト初期化）</button>
    <button onclick="showUsedTokens()">使用済みトークン一覧</button>

    <div id="results"></div>

    <script>
        function clearAll() {
            localStorage.clear();
            document.getElementById('results').innerHTML = '<div class="success test">✅ localStorage クリア完了</div>';
        }

        function showUsedTokens() {
            const usedTokens = JSON.parse(localStorage.getItem('used_tokens') || '[]');
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            const sessionToken = localStorage.getItem('session_token');

            document.getElementById('results').innerHTML = `
                <div class="info test">
                    <h3>現在の状態</h3>
                    <pre>使用済みトークン: ${JSON.stringify(usedTokens, null, 2)}</pre>
                    <pre>セッショントークン: ${sessionToken || 'なし'}</pre>
                    <pre>ユーザー情報: ${JSON.stringify(user, null, 2)}</pre>
                </div>
            `;
        }

        async function testToken(token, expectedResult) {
            const resultsDiv = document.getElementById('results');
            const testDiv = document.createElement('div');
            testDiv.className = 'test';

            testDiv.innerHTML = `<h3>テスト: ${token || '(トークンなし)'}</h3><p>期待結果: ${expectedResult}</p><p>検証中...</p>`;
            resultsDiv.appendChild(testDiv);

            // used_tokens チェック
            const usedTokens = JSON.parse(localStorage.getItem('used_tokens') || '[]');

            if (!token) {
                testDiv.innerHTML += `<p class="error">❌ トークンなし → エラー表示されるはず</p>`;
                testDiv.className = 'test error';
                return;
            }

            if (usedTokens.includes(token)) {
                testDiv.innerHTML += `<p class="error">❌ トークン既に使用済み: ${token}</p>`;
                testDiv.className = 'test error';
                return;
            }

            // トークン形式チェック
            if (!token.startsWith('TEST_') && !token.startsWith('ADMIN_')) {
                testDiv.innerHTML += `<p class="error">❌ 無効なトークン形式</p>`;
                testDiv.className = 'test error';
                return;
            }

            // トークンを使用済みに
            usedTokens.push(token);
            localStorage.setItem('used_tokens', JSON.stringify(usedTokens));

            // セッション作成（簡易版）
            const sessionToken = 'session_test_' + Date.now();
            localStorage.setItem('session_token', sessionToken);
            localStorage.setItem('invite_token', token);

            testDiv.innerHTML += `<p class="success">✅ 登録成功</p>`;
            testDiv.innerHTML += `<pre>使用済みトークン追加: ${token}</pre>`;
            testDiv.className = 'test success';
        }

        // 自動テスト実行
        window.onload = function() {
            const runTests = confirm('自動テストを実行しますか？（localStorageをクリアします）');
            if (!runTests) return;

            localStorage.clear();

            setTimeout(() => testToken('TEST_001_ABC123', '成功'), 500);
            setTimeout(() => testToken('TEST_001_ABC123', 'エラー（使用済み）'), 1500);
            setTimeout(() => testToken('TEST_002_DEF456', '成功'), 2500);
            setTimeout(() => testToken(null, 'エラー（トークンなし）'), 3500);
            setTimeout(() => showUsedTokens(), 4500);
        };
    </script>
</body>
</html>
